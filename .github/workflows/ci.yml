name: CI

on:
  push:
    branches: [master, wip_*]
  pull_request:
    branches: [master]

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libsqlite3-dev \
          libbz2-dev

    - name: Configure perf permissions
      run: |
        # Allow perf_event_open for profiling
        echo 1 | sudo tee /proc/sys/kernel/perf_event_paranoid

    - name: Build coz
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo
        make -j$(nproc)

    - name: Build toy benchmark
      run: |
        cd build
        cmake .. -DBUILD_BENCHMARKS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo
        make -j$(nproc) toy

    - name: Verify build artifacts
      run: |
        test -f build/libcoz/libcoz.so
        test -x build/benchmarks/toy/toy
        echo "Build artifacts verified"

    - name: Run toy benchmark with coz
      run: |
        cd build
        # Run coz with the toy benchmark for a short duration
        timeout 30 ../coz run -o profile.coz --- ./benchmarks/toy/toy || true

        # Check that profile was created
        if [ ! -f profile.coz ]; then
          echo "ERROR: profile.coz was not created"
          exit 1
        fi

        echo "Profile created successfully"

    - name: Validate profile output
      run: |
        cd build

        # Check profile has content
        if [ ! -s profile.coz ]; then
          echo "ERROR: profile.coz is empty"
          exit 1
        fi

        echo "=== Profile Contents ==="
        cat profile.coz
        echo ""

        # Check for expected profile format (should contain experiment lines)
        EXPERIMENT_COUNT=$(grep -c 'experiment' profile.coz || echo 0)
        echo "=== Profile Summary ==="
        echo "  Total lines: $(wc -l < profile.coz)"
        echo "  Experiments: $EXPERIMENT_COUNT"

        if [ "$EXPERIMENT_COUNT" -eq 0 ]; then
          echo "ERROR: No experiment data in profile"
          exit 1
        fi

        # Validate profile references toy.cpp (the benchmark source)
        if grep -q "toy.cpp" profile.coz; then
          echo "  Source file: toy.cpp found in profile"
        else
          echo "WARNING: toy.cpp not found in profile experiments"
        fi

        # Check that experiments have valid format: experiment\tselected\tspeedup\t...
        # Valid experiments should have tab-separated fields
        VALID_EXPERIMENTS=$(grep '^experiment' profile.coz | head -1)
        if [ -n "$VALID_EXPERIMENTS" ]; then
          FIELD_COUNT=$(echo "$VALID_EXPERIMENTS" | awk -F'\t' '{print NF}')
          echo "  Fields per experiment: $FIELD_COUNT"
          if [ "$FIELD_COUNT" -lt 5 ]; then
            echo "ERROR: Experiment format appears invalid (expected at least 5 fields)"
            exit 1
          fi
        fi

        echo ""
        echo "Profile validation PASSED"

    - name: Upload profile artifact
      uses: actions/upload-artifact@v4
      with:
        name: coz-profile
        path: build/profile.coz
        retention-days: 7
